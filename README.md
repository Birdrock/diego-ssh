# diego-ssh

Diego-ssh is an implmentation of an ssh proxy server and a lightweight
ssh daemon. When deployed and configured correctly, they provide a simple and
scalable way access containers associated with LRP instances.

## Proxy

The proxy server hosts the user-accessible ssh endpoint and is responsble for
authentication, policy enforcment, and access controls in the context of Cloud
Foundry. After succesfully authenticating with the proxy, the proxy will
attempt to locate the target container and create an ssh session to the
container. Once both sessions have been established, the proxy will manage the
communication between the user's ssh client and the container's ssh daemon.

The container must run an ssh daemon inside the container on a port that is
exposed to the host.

### Proxy Authentication

Clients authenticate with the proxy using a specially formed user name that
describes the authentication domain and target container and a password that
contains the appropriate credentials for the domain.

For Diego, the user is of the form `diego:`_process-guid_/_index_ and the
password must hold the receptor credentials in the form _user_:_password_.

Client example:

```
ssh -p 2222 'diego:my-process-guid/1'@ssh.10.244.0.34.xip.io
```

The user and password used by the proxy are extracted from the diegoAPIURL
that is specified on the command line. If the user info field is empty, the
password will be empty as well.

## SSH Daemon

The ssh daemon is a lightweight implementation that is built around go's ssh
library. It supports command execution, interactive shells, and local port
forwarding. The daemon is self-contained and has no dependencies on the
container root filesystem.

The daemon is expected to be made available on a file server and Diego LRPs
that want to use it can include a download action to acquire the binary and a
run action to start it.

## Proxy to Container Authentication

When the proxy attempts to handshake with the SSH daemon inside the target
container, it will use the information associated with the `diego-ssh` key in
the LRP routes.

### `container_port` [required]
`container_port` indicates which port inside the container the ssh daemon is
listening on. The proxy will attempt to connect to host side mapping of this
port after authenticating the client.

### `host_fingerprint` [optional]
When present, `host_fingerprint` declares the expected fingerprint of the SSH
daemon's host public key. When the fingerprint of the actual target's host key
does not match the expected fingerprint, the connection is terminated. The
fingerprint should only contain the hex string generated by `ssh-keygen -l`.

### `user` [optional]
`user` declares the user ID to use during authentication with the container's
SSH daemon. While it's not a required part of the routing data, it is required
for password authentication and may be required for public key authentication.

### `password` [optional]
`password` declares the password to use during password authentication with
the container's ssh daemon.

### `private_key` [optional]
`private_key` declares the private key to use when authenticating with the
container's SSH daemon. If present, the key must be a PEM encoded  RSA or DSA
public key.

##### Example LRP
```json
{
  "process_guid": "ssh-process-guid",
  "domain": "ssh-experiments",
  "rootfs": "preloaded:cflinuxfs2",
  "instances": 1,
  "start_timeout": 30,
  "setup": {
    "download": {
      "artifact": "diego-sshd",
      "from": "http://file-server.service.consul:8080/v1/static/diego-sshd/diego-sshd.tgz",
      "to": "/tmp",
      "cache_key": "diego-sshd"
    }
  },
  "action": {
    "run": {
      "path": "/tmp/diego-sshd",
      "args": [
          "-address=0.0.0.0:2222",
          "-authorizedKey=ssh-rsa ..."
      ],
      "env": [],
      "resource_limits": {}
    }
  },
  "ports": [ 2222 ],
  "routes": {
    "diego-ssh": {
      "container_port": 2222,
      "private_key": "PEM encoded PKCS#1 private key"
    }
  }
}
```

##### Dependencies
If you wish to use `scp` to copy files in and out of the containers, the
container root file system must include `/usr/bin/scp`. The Cloud Foundry root
file system [cflinuxfs2][cflinuxfs2] already contain
the binaries but custom root file systems or docker images may not.

scp example:
```
scp -oUser='diego:ssh-process-guid/0' -P 2222 my-local-file.json ssh.10.244.0.34.xip.io:my-remote-file.json
```

[cflinuxfs2]: https://github.com/cloudfoundry/stacks/tree/master/cflinuxfs2

